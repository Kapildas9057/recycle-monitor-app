rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------
    // üîê Helper: Check login
    // -------------------------
    function isLoggedIn() {
      return request.auth != null;
    }

    // -------------------------
    // üëë Super Admin Check
    // (YOUR REAL UID HERE)
    // -------------------------
    function isSuperAdmin() {
      return request.auth != null &&
             request.auth.uid == "2PpAy72RluagHTsQJv9nQlvmTkn2";
    }

    // -------------------------
    // üß© Get User Role
    // (Safe synchronous lookup)
    // -------------------------
    function userRole() {
      return isLoggedIn()
        ? get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.role
        : null;
    }

    // ================================================================
    // APPROVAL REQUESTS
    // ================================================================
    match /approval_requests/{uid} {

      // Any logged-in user can create their own approval request
      allow create: if isLoggedIn() && uid == request.auth.uid;

      // Superadmin can read/update any request
      allow read, update: if isSuperAdmin();

      // Regular users can only read their own request
      allow read: if isLoggedIn() && uid == request.auth.uid;
    }

    // ================================================================
    // USER PROFILES
    // ================================================================
    match /user_profiles/{uid} {

      // Full access for superadmin
      allow read, write: if isSuperAdmin();

      // Users can only read their own profile
      allow read: if isLoggedIn() && uid == request.auth.uid;
    }

    // ================================================================
    // USER ROLES
    // ================================================================
    match /user_roles/{uid} {

      // Superadmin can fully manage
      allow read, write: if isSuperAdmin();

      // Users can read their own role
      allow read: if isLoggedIn() && uid == request.auth.uid;
    }

    // ================================================================
    // WASTE ENTRIES
    // ================================================================
    match /waste_entries/{docId} {

      // All logged-in users can create entries
      allow create: if isLoggedIn();

      // Anyone logged in can view all entries
      allow read: if isLoggedIn();

      // Only admin or superadmin can update
      allow update: if isSuperAdmin() || userRole() == "admin";

      // Only superadmin can delete
      allow delete: if isSuperAdmin();
    }
  }
}
