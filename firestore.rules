rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper functions ---
    function isLoggedIn() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return request.auth != null &&
             request.auth.token.email == "kd850539@gmail.com";
    }

    async function userRole() {
      if (!isLoggedIn()) return null;

      return get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.role;
    }

    // ================================================================
    // APPROVAL REQUESTS
    // ================================================================
    match /approval_requests/{uid} {

      // Anyone logged in can create their own approval request
      allow create: if isLoggedIn() && uid == request.auth.uid;

      // Super admin can read & update all
      allow read, update: if isSuperAdmin();

      // No one else can read others' requests (privacy)
      allow read: if isLoggedIn() && uid == request.auth.uid;
    }

    // ================================================================
    // USER PROFILES
    // ================================================================
    match /user_profiles/{uid} {

      // Super admin can manage all profiles
      allow read, write: if isSuperAdmin();

      // Normal users can only read their own profile
      allow read: if isLoggedIn() && uid == request.auth.uid;
    }

    // ================================================================
    // USER ROLES
    // ================================================================
    match /user_roles/{uid} {

      // Super admin full control
      allow read, write: if isSuperAdmin();

      // User can read their own role
      allow read: if isLoggedIn() && uid == request.auth.uid;
    }

    // ================================================================
    // WASTE ENTRIES
    // ================================================================
    match /waste_entries/{docId} {

      // Anyone logged in can create waste entries
      allow create: if isLoggedIn();

      // Employees & admins can read all waste entries
      allow read: if isLoggedIn();

      // Only admins & super-admins can update entries
      allow update: if isSuperAdmin() ||
                     userRole() == "admin";

      // Only super-admin can delete entries
      allow delete: if isSuperAdmin();
    }
  }
}
